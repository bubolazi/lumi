# Email Confirmation - Supabase Integration Quick Reference

## Overview
This guide provides quick copy-paste instructions for configuring the email confirmation templates in Supabase.

## Prerequisites
- Supabase project created
- Access to Supabase Dashboard

## Step-by-Step Configuration

### 1. Access Email Templates in Supabase

1. Log in to [Supabase Dashboard](https://app.supabase.com)
2. Select your project
3. Go to **Authentication** → **Email Templates**
4. Select **Confirm signup** from the template dropdown

### 2. Configure Subject Line

In the **Subject** field, enter:
```
Потвърди своя имейл - УЧЕБЕН ТЕРМИНАЛ
```

### 3. Configure HTML Template

Copy the entire contents of `emails/confirmation.html` and paste into the **HTML Template** field.

**Important**: Do NOT modify the template variables:
- `{{ .User.UserMetadata.name }}`
- `{{ .ConfirmationURL }}`

These will be automatically populated by Supabase.

### 4. Configure Plain Text Template

Copy the entire contents of `emails/confirmation.txt` and paste into the **Plain Text Template** field.

### 5. Configure URL Settings

Go to **Authentication** → **URL Configuration** and set:

**Site URL** (Production):
```
https://your-production-domain.com
```

**Redirect URLs** (Add these):
```
https://your-production-domain.com/**
http://localhost:8000/**
http://localhost:3000/**
```

### 6. Configure Email Settings (Optional)

Go to **Settings** → **Auth** and verify:

- ✅ **Enable email confirmations** is ON
- ✅ **Enable email change confirmations** is ON
- ⏱️ **Email confirmation timeout**: 24 hours (default)

### 7. Test the Email Flow

#### Option A: Manual Test via Dashboard

1. Go to **Authentication** → **Users**
2. Click **Add user** → **Create new user**
3. Enter test email and password
4. Check the email inbox for confirmation email

#### Option B: Test via Application

```javascript
// Example signup code
const { data, error } = await supabase.auth.signUp({
  email: 'test@example.com',
  password: 'securepassword123',
  options: {
    data: {
      name: 'Тестов Потребител'  // This populates {{ .User.UserMetadata.name }}
    },
    emailRedirectTo: 'https://your-domain.com/welcome'  // Where to redirect after confirmation
  }
})
```

### 8. Verify Email Delivery

After signup, check:
1. ✅ Email arrives in inbox (check spam if not)
2. ✅ Green terminal theme displays correctly
3. ✅ User name appears in greeting
4. ✅ Confirmation button/link works
5. ✅ After clicking, redirects to your app

## Template Variables Reference

| Variable | Description | Populated From |
|----------|-------------|----------------|
| `{{ .User.UserMetadata.name }}` | User's display name | `options.data.name` in signUp call |
| `{{ .ConfirmationURL }}` | Email confirmation link | Auto-generated by Supabase |
| `{{ .SiteURL }}` | Your configured site URL | Supabase project settings |

## Customization Options

### Change Redirect After Confirmation

When calling `signUp()`, set the `emailRedirectTo` option:

```javascript
const { data, error } = await supabase.auth.signUp({
  email: userEmail,
  password: userPassword,
  options: {
    data: { name: userName },
    emailRedirectTo: 'https://your-domain.com/dashboard'  // Custom redirect
  }
})
```

### Custom Email Provider (Optional)

If you want to use a custom SMTP provider instead of Supabase's default:

1. Go to **Settings** → **Auth**
2. Scroll to **SMTP Settings**
3. Configure your SMTP server details

**Note**: Using custom SMTP requires additional configuration and testing.

## Troubleshooting

### Email not received
- ✅ Check spam/junk folder
- ✅ Verify email address is correct
- ✅ Check Supabase logs: **Authentication** → **Logs**
- ✅ Verify SMTP settings if using custom provider

### Template not rendering correctly
- ✅ Ensure you copied the entire HTML template
- ✅ Check that template variables have correct syntax
- ✅ Test in multiple email clients (Gmail, Outlook, etc.)

### Confirmation link not working
- ✅ Verify redirect URLs are configured
- ✅ Check link hasn't expired (24 hours default)
- ✅ Ensure Site URL matches your production domain

### User name not showing
- ✅ Verify you're passing `options.data.name` in signUp call
- ✅ Check the variable syntax: `{{ .User.UserMetadata.name }}`
- ✅ Ensure there are no extra spaces in the variable name

## Security Notes

1. **Anon Key is Safe**: The Supabase anon key can be safely exposed in client code
2. **RLS Policies**: Ensure Row Level Security (RLS) is configured properly
3. **Email Verification**: Always require email verification for production apps
4. **HTTPS Only**: Use HTTPS for all redirect URLs in production

## Additional Resources

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Email Templates Guide](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Full Integration Guide](../docs/SUPABASE_INTEGRATION_GUIDE.md)
- [Quick Start Guide](../docs/SUPABASE_QUICK_START.md)

## Next Steps

After configuring the email templates:

1. ✅ Test with a real email account
2. ✅ Verify theme displays correctly in different email clients
3. ✅ Test the full signup → confirmation → redirect flow
4. ✅ Monitor email delivery in production
5. ✅ Set up email analytics (optional)

## Support

For issues or questions:
- Check the email templates README: `emails/README.md`
- Review Supabase documentation
- Check application logs for errors
